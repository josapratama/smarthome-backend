asyncapi: "2.6.0"
info:
  title: Smart Home MQTT API
  version: "1.0.0"
  description: |
    MQTT topic contract for Smart Home IoT Backend with AI-powered analytics.

    This specification defines the MQTT message protocols used for real-time
    communication between IoT devices and the Smart Home Backend system.

    **Topic Structure:**
    ```
    smarthome/{homeId}/{deviceId}/{messageType}
    ```

    **Supported Message Types:**
    - `telemetry` - Sensor data from devices
    - `status` - Device online/offline status
    - `heartbeat` - Periodic device health checks
    - `commands` - Control commands to devices
    - `config` - Configuration updates for devices

    **Authentication:**
    - MQTT username/password authentication
    - Device-specific credentials
    - Access Control Lists (ACLs) for topic permissions

servers:
  development:
    url: localhost:1883
    protocol: mqtt
    description: Local development broker
  production:
    url: mqtt.yourdomain.com:1883
    protocol: mqtt
    description: Production MQTT broker

channels:
  # Device telemetry data
  smarthome/{homeId}/{deviceId}/telemetry:
    parameters:
      homeId:
        description: Home identifier (integer as string)
        schema:
          type: string
          pattern: "^[0-9]+$"
          example: "1"
      deviceId:
        description: Device identifier (integer as string or MAC address)
        schema:
          type: string
          example: "1"
    publish:
      summary: Device sensor data
      description: Real-time sensor readings from IoT devices
      message:
        $ref: "#/components/messages/TelemetryData"

  # Device status updates
  smarthome/{homeId}/{deviceId}/status:
    parameters:
      homeId:
        schema:
          type: string
          pattern: "^[0-9]+$"
      deviceId:
        schema:
          type: string
    publish:
      summary: Device status updates
      description: Device online/offline status and system information
      message:
        $ref: "#/components/messages/DeviceStatus"

  # Device heartbeat
  smarthome/{homeId}/{deviceId}/heartbeat:
    parameters:
      homeId:
        schema:
          type: string
          pattern: "^[0-9]+$"
      deviceId:
        schema:
          type: string
    publish:
      summary: Device heartbeat
      description: Periodic health check from devices
      message:
        $ref: "#/components/messages/Heartbeat"

  # Device commands
  smarthome/{homeId}/{deviceId}/commands:
    parameters:
      homeId:
        schema:
          type: string
          pattern: "^[0-9]+$"
      deviceId:
        schema:
          type: string
    subscribe:
      summary: Device control commands
      description: Commands sent from backend to control devices
      message:
        $ref: "#/components/messages/DeviceCommand"

  # Device configuration
  smarthome/{homeId}/{deviceId}/config:
    parameters:
      homeId:
        schema:
          type: string
          pattern: "^[0-9]+$"
      deviceId:
        schema:
          type: string
    subscribe:
      summary: Device configuration updates
      description: Configuration changes sent to devices
      message:
        $ref: "#/components/messages/DeviceConfig"

components:
  messages:
    TelemetryData:
      name: TelemetryData
      contentType: application/json
      description: |
        Comprehensive sensor data from IoT devices. Supports multiple sensor types
        including environmental sensors, power monitoring, and safety sensors.
      payload:
        type: object
        properties:
          timestamp:
            type: string
            format: date-time
            description: ISO 8601 timestamp of the reading
            example: "2026-02-13T12:00:00.000Z"
          deviceId:
            type: string
            description: Device identifier
            example: "ESP32_001"

          # Basic environmental sensors
          current:
            type: number
            description: Current measurement (Amperes)
            example: 0.72
          gasPpm:
            type: number
            description: Gas concentration (parts per million)
            example: 450
          flame:
            type: boolean
            description: Flame/fire detection status
            example: false
          binLevel:
            type: number
            description: Trash bin fill level (percentage or distance)
            example: 35.5

          # Power monitoring (PZEM004 v3)
          powerW:
            type: number
            description: Power consumption (Watts)
            example: 120.5
          energyKwh:
            type: number
            description: Energy consumption (Kilowatt-hours)
            example: 3.14
          voltageV:
            type: number
            description: Voltage (Volts)
            example: 220.5
          currentA:
            type: number
            description: Current (Amperes) - from power meter
            example: 0.55
          frequencyHz:
            type: number
            description: Frequency (Hertz)
            example: 50.0
          powerFactor:
            type: number
            description: Power factor (0.0 to 1.0)
            example: 0.95

          # Ultrasonic distance sensor
          distanceCm:
            type: number
            description: Distance measurement (centimeters)
            example: 25.3

          # Additional environmental sensors
          temperature:
            type: number
            description: Temperature (Celsius)
            example: 23.5
          humidity:
            type: number
            description: Humidity (percentage)
            example: 65.2

          # Device metadata
          metadata:
            type: object
            description: Additional device information
            properties:
              firmwareVersion:
                type: string
                example: "v2.1.0"
              signalStrength:
                type: integer
                description: WiFi signal strength (dBm)
                example: -45
              batteryLevel:
                type: integer
                description: Battery level (percentage)
                example: 85
              freeMemory:
                type: integer
                description: Free memory (bytes)
                example: 45000
        required: [timestamp, deviceId]

    DeviceStatus:
      name: DeviceStatus
      contentType: application/json
      description: Device status and system information
      payload:
        type: object
        properties:
          timestamp:
            type: string
            format: date-time
            example: "2026-02-13T12:00:00.000Z"
          deviceId:
            type: string
            example: "ESP32_001"
          online:
            type: boolean
            description: Device online status
            example: true
          status:
            type: object
            properties:
              uptime:
                type: integer
                description: Device uptime (seconds)
                example: 86400
              freeMemory:
                type: integer
                description: Available memory (bytes)
                example: 45000
              wifiSignal:
                type: integer
                description: WiFi signal strength (dBm)
                example: -45
              batteryLevel:
                type: integer
                description: Battery level (percentage)
                example: 85
              firmwareVersion:
                type: string
                example: "v2.1.0"
          errors:
            type: array
            description: Current error conditions
            items:
              type: string
            example: []
        required: [timestamp, deviceId, online]

    Heartbeat:
      name: Heartbeat
      contentType: application/json
      description: Periodic device health check
      payload:
        type: object
        properties:
          timestamp:
            type: string
            format: date-time
            example: "2026-02-13T12:00:00.000Z"
          deviceId:
            type: string
            example: "ESP32_001"
          uptime:
            type: integer
            description: Device uptime (seconds)
            example: 86400
          freeMemory:
            type: integer
            description: Available memory (bytes)
            example: 45000
          wifiSignal:
            type: integer
            description: WiFi signal strength (dBm)
            example: -45
        required: [timestamp, deviceId]

    DeviceCommand:
      name: DeviceCommand
      contentType: application/json
      description: Control commands sent to devices
      payload:
        type: object
        properties:
          commandId:
            type: string
            description: Unique command identifier
            example: "cmd_123456789"
          timestamp:
            type: string
            format: date-time
            example: "2026-02-13T12:00:00.000Z"
          type:
            type: string
            description: Command type
            enum: [SET_POWER, SET_BRIGHTNESS, SET_COLOR, RESET, UPDATE_CONFIG]
            example: "SET_POWER"
          payload:
            type: object
            description: Command-specific parameters
            properties:
              power:
                type: boolean
                example: true
              brightness:
                type: integer
                minimum: 0
                maximum: 100
                example: 80
              color:
                type: string
                pattern: "^#[0-9A-Fa-f]{6}$"
                example: "#FF5733"
          source:
            type: string
            enum: [USER, BACKEND, AI, AUTOMATION]
            example: "USER"
          correlationId:
            type: string
            description: Request correlation identifier
            example: "corr_987654321"
        required: [commandId, timestamp, type, payload, source]

    DeviceConfig:
      name: DeviceConfig
      contentType: application/json
      description: Configuration updates for devices
      payload:
        type: object
        properties:
          timestamp:
            type: string
            format: date-time
            example: "2026-02-13T12:00:00.000Z"
          config:
            type: object
            description: Device configuration parameters
            properties:
              sampleRate:
                type: integer
                description: Sensor sampling rate (seconds)
                example: 30
              alertThresholds:
                type: object
                properties:
                  gas:
                    type: number
                    description: Gas alert threshold (ppm)
                    example: 800
                  temperature:
                    type: number
                    description: Temperature alert threshold (Celsius)
                    example: 35
                  humidity:
                    type: number
                    description: Humidity alert threshold (percentage)
                    example: 80
              powerSaving:
                type: boolean
                description: Enable power saving mode
                example: true
              wifiConfig:
                type: object
                properties:
                  ssid:
                    type: string
                    example: "SmartHome_Network"
                  reconnectInterval:
                    type: integer
                    description: WiFi reconnection interval (seconds)
                    example: 30
              mqttConfig:
                type: object
                properties:
                  keepAlive:
                    type: integer
                    description: MQTT keep-alive interval (seconds)
                    example: 60
                  qos:
                    type: integer
                    enum: [0, 1, 2]
                    description: MQTT Quality of Service level
                    example: 1
        required: [timestamp, config]

  securitySchemes:
    mqttAuth:
      type: userPassword
      description: MQTT username and password authentication

security:
  - mqttAuth: []
